\# Services



Microservices built on `app\_kernel` - the shared infrastructure layer.



\## Structure



```

services/

├── launch.bat              # Windows launcher

├── new\_app.bat             # Create new service (drag manifest onto it)

├── ai\_agents/              # Example: full-featured service

└── {my\_service}/           # Generated by new\_app.bat:

&nbsp;   ├── manifest.yaml       # Your input - edit to change \_gen/

&nbsp;   ├── config.py           # Generated once - safe to customize

&nbsp;   ├── main.py             # Generated once - safe to customize  

&nbsp;   ├── worker.py           # Generated once - safe to customize

&nbsp;   ├── \_gen/               # REGENERATED on every appctl generate

&nbsp;   │   ├── \_\_init\_\_.py

&nbsp;   │   ├── crud.py         

&nbsp;   │   ├── schemas.py      

&nbsp;   │   ├── db\_schema.py    

&nbsp;   │   └── routes/         

&nbsp;   └── src/                # YOUR CODE - never touched

&nbsp;       ├── \_\_init\_\_.py

&nbsp;       ├── routes/

&nbsp;       │   ├── \_\_init\_\_.py   # Register routers here

&nbsp;       │   └── custom.py     # Example route (edit/rename)

&nbsp;       └── workers/

&nbsp;           ├── \_\_init\_\_.py   # Register tasks here

&nbsp;           └── tasks.py      # Example task (edit/rename)

```



> \*\*Regenerating\*\*: `appctl generate` only rebuilds `\_gen/`. Everything else is untouched.



\## Batch Files



| File | Usage | Description |

|------|-------|-------------|

| `new\_app.bat` | Drag manifest onto it | Creates a new service from manifest.yaml |

| `launch.bat` | Run directly or drag manifest | Starts API server + worker for a service |



\### new\_app.bat



Creates a working service scaffold:



```

Drag manifest.yaml → new\_app.bat

&nbsp;                         ↓

&nbsp;             services/{name}/

&nbsp;             ├── manifest.yaml  (copied)

&nbsp;             ├── config.py      (generated)

&nbsp;             ├── main.py        (generated)

&nbsp;             ├── worker.py      (generated)

&nbsp;             ├── \_gen/          (generated CRUD)

&nbsp;             └── src/           (example code to customize)

&nbsp;                 ├── routes/custom.py

&nbsp;                 └── workers/tasks.py

```



\### launch.bat



Starts the service:



```

Run launch.bat          → Starts ai\_agents (default)

Drag manifest → launch.bat → Starts that service

```



Launches:

\- Redis (via Docker)

\- API server (uvicorn with reload)

\- Background worker



---



\## Quick Start



\### Create a New Service (Windows)



1\. Write a `manifest.yaml` with your entities

2\. Drag it onto `new\_app.bat`

3\. Run `launch.bat`



\### Run Existing Service (Windows)



```batch

cd shared\_libs

launch.bat

```



Or drag a `manifest.yaml` onto `launch.bat` to launch a specific service.



\### Linux/Mac



```bash

cd shared\_libs

uvicorn services.ai\_agents.main:app --reload --host 0.0.0.0 --port 8000

```



\### Worker (background jobs)



```bash

cd shared\_libs

python -m services.ai\_agents.worker

```



\## The Generated vs Custom Pattern



| What | On `new\_app` | On `appctl generate` | Editable? |

|------|--------------|----------------------|-----------|

| `manifest.yaml` | Copied | Not touched | ✅ Edit to change schema |

| `src/` | Created empty | Never touched | ✅ Your code |

| `config.py`, `main.py`, `worker.py` | Generated | Not touched | ✅ Safe to customize |

| `\_gen/` | Generated | \*\*Regenerated\*\* | ❌ Don't edit |



\### Why This Pattern?



1\. \*\*Speed\*\*: Get a working service instantly from `manifest.yaml`

2\. \*\*Safety\*\*: Your code in `src/` is never overwritten

3\. \*\*Flexibility\*\*: Root files can be customized after initial generation



\### Regenerating `\_gen/`



After editing `manifest.yaml` (e.g., adding entities):



```bash

cd services/my\_service

python ../../appctl.py generate

```



This rebuilds `\_gen/` only. Your `src/`, `main.py`, `config.py`, `worker.py` are untouched.



\## Creating a New Service



\### Option 1: Drag \& Drop (Windows)



1\. Create a `manifest.yaml` anywhere:

```yaml

name: my\_service

version: "1.0.0"



database:

&nbsp; type: sqlite

&nbsp; path: "./data/my\_service.db"



entities:

&nbsp; - name: item

&nbsp;   table: items

&nbsp;   soft\_delete: true

&nbsp;   fields:

&nbsp;     - name: name

&nbsp;       type: str

&nbsp;       required: true

```



2\. \*\*Drag the manifest onto `new\_app.bat`\*\*



This creates:

\- `config.py`, `main.py`, `worker.py` (generated once, customizable)

\- `\_gen/` (regenerated on schema changes)

\- `src/routes/custom.py` and `src/workers/tasks.py` (working examples)



> \*\*Note\*\*: `new\_app.bat` calls `appctl.py new` under the hood.



3\. Launch with `launch.bat` (or drag the new manifest onto it)



4\. Add custom logic to `src/` as needed



\### Option 2: Command Line



```bash

cd shared\_libs

python appctl.py generate path/to/manifest.yaml

```



Same result as drag \& drop.



\## Configuration



The generated `config.py` reads environment variables. Set via `.env` file or shell:



```bash

\# Database

DATABASE\_TYPE=sqlite

DATABASE\_NAME=./data/myservice.db



\# Optional

REDIS\_URL=redis://localhost:6379

JWT\_SECRET=change-me

DEBUG=true

```



You can customize `config.py` after generation - it won't be overwritten.



\## Endpoints



All services get these from `app\_kernel`:



| Endpoint | Description |

|----------|-------------|

| `GET /healthz` | Liveness probe |

| `GET /readyz` | Readiness probe |

| `GET /metrics` | Prometheus metrics (admin) |

| `GET /docs` | OpenAPI documentation |



Plus service-specific routes under `/api/v1/`.



\## Database



Services use the `databases` library through `app\_kernel`. See generated examples in `src/routes/custom.py` and `src/workers/tasks.py`.



\### Entity Methods



| Method | Description |

|--------|-------------|

| `get\_entity(table, id)` | Get by ID |

| `find\_entities(table, where, params, limit, offset)` | Query with filters |

| `save\_entity(table, dict)` | Create or update |

| `delete\_entity(table, id, permanent=False)` | Soft/hard delete |

| `count\_entities(table, where, params)` | Count matching |



\### Usage



```python

\# In routes

from ..deps import db\_connection



@router.get("/items")

async def list\_items(db=Depends(db\_connection)):

&nbsp;   return await db.find\_entities("items")



\# In workers

from ..deps import get\_db\_connection



async with get\_db\_connection() as db:

&nbsp;   await db.save\_entity("items", {...})

```



\## Adding Custom Code



Generated `src/` includes working examples you can edit:



\### Routes: `src/routes/custom.py`



```python

from ..deps import db\_connection



@router.get("/items/{item\_id}")

async def get\_item(item\_id: str, db=Depends(db\_connection)):

&nbsp;   item = await db.get\_entity("items", item\_id)

&nbsp;   if not item:

&nbsp;       raise HTTPException(status\_code=404, detail="Item not found")

&nbsp;   return item

```



Add more routes → import in `src/routes/\_\_init\_\_.py`



\### Workers: `src/workers/tasks.py`



```python

from ..deps import get\_db\_connection



async def process\_item(ctx, item\_id: str):

&nbsp;   async with get\_db\_connection() as db:

&nbsp;       item = await db.get\_entity("items", item\_id)

&nbsp;       item\["processed"] = True

&nbsp;       await db.save\_entity("items", item)

```



Add more tasks → register in `src/workers/\_\_init\_\_.py`:

```python

tasks = {

&nbsp;   "process\_item": process\_item,

&nbsp;   "my\_new\_task": my\_new\_task,  # add here

}

```



\### Enqueue from routes



```python

from backend.app\_kernel.jobs import get\_job\_client



@router.post("/items/{item\_id}/process")

async def enqueue\_processing(item\_id: str):

&nbsp;   client = get\_job\_client()

&nbsp;   job\_id = await client.enqueue("process\_item", item\_id=item\_id)

&nbsp;   return {"job\_id": job\_id}

```



\## Testing



```bash

cd shared\_libs

uvicorn services.{name}.main:app --reload



\# Test

curl http://localhost:8000/healthz

curl http://localhost:8000/docs

```



\## Troubleshooting



\### Import Errors



Run from `shared\_libs/`:

```bash

cd shared\_libs

uvicorn services.my\_service.main:app --reload

```



\### Database Errors



SQLite creates the file automatically, but the directory must exist.



\### Redis



Optional. Without it, jobs run in-memory (not persistent).



---



\## Services Index



| Service | Port | Description |

|---------|------|-------------|

| `ai\_agents` | 8000 | Full example with AI chat, RAG, auth |

